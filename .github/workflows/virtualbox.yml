name: VirtualBox test
on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
concurrency:
  group: ${{ github.head_ref || github.sha }}-${{ github.workflow }}
  cancel-in-progress: true
jobs:
  on_jammy:
    name: Test with CGroup V1 on jammy
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - name: Set up vagrant
        run: |
          sudo apt-get install -y vagrant virtualbox
          vagrant --version
          vagrant status
      - name: Spin up vagrant
        run: |
          vagrant up --provider=virtualbox ${{ matrix.rake-job }}
      - name: Run Test amazonlinux-2 on ubuntu-22.04
        run: |
          vagrant ssh amazonlinux-2 -- /host/test-yum.sh
  on_macos:
    name: Test with CGroup V1 on macos
    runs-on: macos-13
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - name: Set up vagrant
        run: |
          vagrant --version
          vagrant status
          lsmod | grep kvm
      - name: Spin up vagrant
        run: |
          vagrant up --provider virtualbox --debug ${{ matrix.rake-job }}
      - name: Run Test amazonlinux-2 on macos-latest
        run: |
          vagrant ssh amazonlinux-2 -- /host/test-yum.sh
